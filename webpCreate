#!/bin/zsh

echo "üõ†  Running webpCreate in: $(pwd)"

# Check for cwebp
if ! command -v cwebp &> /dev/null; then
  echo "‚ùå cwebp not found. Install with: brew install webp"
  exit 1
fi

# Initialize
converted_jpg=false
converted_png=false
jpg_count=0
png_count=0
webp_count=0
jpg_size=0
png_size=0
webp_size=0

# Helpers
human_size() {
  num_bytes=$1
  echo "$((num_bytes / 1024 / 1024)).$(( (num_bytes / 1024) % 1024 * 100 / 1024 )) MB"
}

ask_file_action() {
  local file="$1"
  while true; do
    echo "‚ö†Ô∏è  '$file' already exists in WEBP/. (o)verwrite / (i)ncrement / (s)kip?"
    read -sk1 choice
    echo ""
    case $choice in
      o|O) return 0 ;;
      i|I) return 1 ;;
      s|S) return 2 ;;
      *) echo "‚ùì Invalid choice. Press o, i, or s." ;;
    esac
  done
}

convert_and_handle_conflict() {
  local input="$1"
  local base="${input%.*}"
  local out="${base}.webp"
  local output_path="$PWD/$out"

  mkdir -p WEBP

  if [[ -e "WEBP/$out" ]]; then
    ask_file_action "$out"
    action=$?
    if [[ $action -eq 0 ]]; then
      cwebp -q 80 "$input" -o "$out"
    elif [[ $action -eq 1 ]]; then
      n=1
      while [[ -e "WEBP/${base}_$n.webp" ]]; do ((n++)); done
      out="${base}_$n.webp"
      cwebp -q 80 "$input" -o "$out"
    else
      return 1
    fi
  else
    cwebp -q 80 "$input" -o "$out"
  fi

  [[ -e "$out" ]] && mv "$out" WEBP/ && return 0
  return 1
}

# JPG/JPEG
jpg_files=(*.jpg *.jpeg *.JPG *.JPEG(N))
if (( ${#jpg_files} > 0 )); then
  mkdir -p JPG
  for file in $jpg_files; do
    [[ -f "$file" ]] || continue
    size=$(stat -f%z "$file")
    if convert_and_handle_conflict "$file"; then
      mv "$file" JPG/
      ((jpg_count++))
      ((jpg_size+=size))
      converted_jpg=true
    fi
  done
fi

# PNG
png_files=(*.png *.PNG(N))
if (( ${#png_files} > 0 )); then
  mkdir -p PNG
  for file in $png_files; do
    [[ -f "$file" ]] || continue
    size=$(stat -f%z "$file")
    if convert_and_handle_conflict "$file"; then
      mv "$file" PNG/
      ((png_count++))
      ((png_size+=size))
      converted_png=true
    fi
  done
fi

# Count WEBP files & size
webp_files=(WEBP/*.webp(N))
for w in $webp_files; do
  size=$(stat -f%z "$w")
  ((webp_count++))
  ((webp_size+=size))
done

# --- Summary ---
total_input_size=$((jpg_size + png_size))
total_saved=$((total_input_size - webp_size))

echo ""
echo "‚úÖ Conversion Summary:"
[[ $jpg_count -gt 0 ]] && echo " - Converted JPG/JPEG files: $jpg_count ‚Üí $(human_size $jpg_size)"
[[ $png_count -gt 0 ]] && echo " - Converted PNG files:      $png_count ‚Üí $(human_size $png_size)"
[[ $webp_count -gt 0 ]] && echo " - Converted WEBP files:     $webp_count ‚Üí $(human_size $webp_size)"

if (( total_input_size > 0 && webp_size > 0 )); then
  percent=$(( (total_saved * 1000 / total_input_size + 5) / 10 )) # rounded %
  echo " - Total Original Size:      $(human_size $total_input_size)"
  echo " - Total WEBP Size:          $(human_size $webp_size)"
  echo " - Size Savings:             $(human_size $total_saved) ($percent% reduction)"
elif (( total_input_size > 0 )); then
  echo "‚ö†Ô∏è  Converted original files but no .webp files were created."
else
  echo "‚ùå No files were converted."
fi
